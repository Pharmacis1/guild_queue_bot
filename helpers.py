from database import get_user_active_queues, get_effective_limit_logic

def get_menu_text(user, custom_title=None):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –º–µ–Ω—é.
    :param user: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    :param custom_title: (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ None ‚Äî —Å—Ç–∞–≤–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
    """
    # –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç—É—Ç –Ω–µ –≤–∞–∂–Ω—ã
    if not user.characters:
        return (
            "üëã <b>–ü—Ä–∏–≤–µ—Ç!</b>\n\n"
            "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Å—ã —Å –ö–•, —Å–ª–µ–¥—É–π –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n"
            "1Ô∏è‚É£ –ó–∞–π–¥–∏ –≤ <b>¬´üë• –ú–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏¬ª</b> –∏ –¥–æ–±–∞–≤—å —Å–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ —Ç–≤–∏–Ω–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å).\n"
            "2Ô∏è‚É£ –ù–∞–∂–º–∏ <b>¬´‚úçÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ –æ—á–µ—Ä–µ–¥—å¬ª</b>, –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é –æ—á–µ—Ä–µ–¥—å –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–∏–∫ —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.\n\n"
            "ü§ñ –ë–æ—Ç –ø—Ä–∏—à–ª–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ú–∞—Å—Ç–µ—Ä –≤—ã–¥–∞—Å—Ç —Ç–µ–±–µ –Ω–∞–≥—Ä–∞–¥—É.\n\n"
            "üëá <b>–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
        )
    
    # --- –°–ë–û–† –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
    active_queues = get_user_active_queues(user.id) 
    current_count = len(active_queues)
    limit = get_effective_limit_logic(user)
    available_slots = limit - current_count
    if available_slots < 0: available_slots = 0
    
    chars_names = [char.nickname for char in user.characters]
    chars_str = ", ".join(chars_names)
    
    if active_queues:
        q_list = [f"- {q.queue.name} ({q.character_name})" for q in active_queues]
        queues_display = "\n".join(q_list)
    else:
        queues_display = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π"

    # --- –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–ê ---
    # –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ–¥–∞–ª–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    header = custom_title if custom_title else "üëã <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</b>"

    return (
        f"{header}\n\n"
        f"üë§ <b>–¢–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:</b>\n{chars_str}\n\n"
        f"üìã <b>–¢–≤–æ–∏ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –ö–• —Ä–µ—Å—ã:</b>\n{queues_display}\n\n"
        f"üìä <b>–õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏:</b> {current_count}/{limit} (–¥–æ—Å—Ç—É–ø–Ω–æ: {available_slots})\n\n"
        f"üëá <b>–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
    )